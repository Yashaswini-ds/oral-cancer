{% extends "base.html" %}
{% block title %}Doctor Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
  <h2 class="fw-bold" style="color: var(--primary-color);">Doctor Dashboard</h2>
  <span class="badge bg-primary rounded-pill px-3 py-2">{{ records|length }} Records Pending</span>
</div>

{% if records and records|length %}
<div class="card border-0 bg-transparent fade-in-up delay-200">
  <div class="card-body p-0">
    <div class="table-responsive rounded-4 shadow-sm bg-white">
      <table class="table align-middle table-hover mb-0">
        <thead class="bg-light text-uppercase small text-muted letter-spacing-1">
          <tr>
            <th class="ps-4 py-3 border-0">Timestamp</th>
            <th class="py-3 border-0">User</th>
            <th class="py-3 border-0">Prediction</th>
            <th class="py-3 border-0">Conf.</th>
            <th class="py-3 border-0">Status</th>
            <th class="py-3 border-0">Scan</th>
            <th class="py-3 border-0">Follow-up</th>
            <th class="py-3 border-0">Media</th>
            <th class="py-3 border-0">Actions</th>
          </tr>
        </thead>
        <tbody class="border-top-0">
          {% for r in records %}
          <tr class="border-bottom-light">
            <td class="ps-4 text-muted small fw-medium">{{ r.timestamp }}</td>
            <td class="fw-bold text-dark">{{ r.username or "Anonymous" }}</td>
            <td>
              <span
                class="badge {% if 'Risk' in r.prediction and 'Low' not in r.prediction %}bg-danger{% else %}bg-success{% endif %} bg-opacity-10 text-{{ 'danger' if 'Risk' in r.prediction and 'Low' not in r.prediction else 'success' }} px-3 py-2 rounded-pill">
                {{ r.prediction }}
              </span>
            </td>
            <td class="fw-bold text-secondary">{{ r.confidence }}%</td>
            <td><span class="badge bg-light text-dark border">{{ r.status }}</span></td>
            <td>
              {% if r.image_path %}
              <a href="{{ url_for('static', filename='uploads/' + r.image_path.split(',')[0] | basename) }}"
                target="_blank" class="d-block rounded-3 overflow-hidden shadow-sm hover-scale transition-transform"
                style="width: 50px; height: 50px;">
                <img src="{{ url_for('static', filename='uploads/' + r.image_path.split(',')[0] | basename) }}"
                  class="w-100 h-100 object-fit-cover">
              </a>
              {% else %}
              <span class="text-muted small">-</span>
              {% endif %}
            </td>
            <td>
              {% if r.follow_up %}
              <span class="badge bg-warning text-dark animate-pulse"><i class="fas fa-exclamation-circle me-1"></i>
                Flagged</span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex gap-2">
                {% if r.image_path %}
                <a class="btn btn-icon btn-light rounded-circle text-muted hover-text-primary transition-colors"
                  href="{{ url_for('view_images', timestamp=r.timestamp) }}" title="View Photos"><i
                    class="fas fa-images"></i></a>
                {% endif %}
                {% if r.audio_path %}
                <a class="btn btn-icon btn-light rounded-circle text-muted hover-text-primary transition-colors"
                  href="{{ '/' + r.audio_path }}" target="_blank" title="Listen Audio"><i class="fas fa-music"></i></a>
                {% endif %}
                <a class="btn btn-icon btn-light rounded-circle text-muted hover-text-primary transition-colors"
                  href="{{ url_for('view_report', timestamp=r.timestamp) }}" target="_blank" title="View PDF"><i
                    class="fas fa-file-pdf"></i></a>
              </div>
            </td>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-light rounded-pill px-3 dropdown-toggle" type="button"
                  data-bs-toggle="dropdown">
                  Action
                </button>
                <ul class="dropdown-menu border-0 shadow-lg rounded-3 mt-2">
                  <li><a class="dropdown-item py-2" href="{{ url_for('chat_doctor', timestamp=r.timestamp) }}"><i
                        class="fas fa-comments me-2 text-primary"></i> Chat</a></li>
                  <li>
                    <form action="{{ url_for( ('unflag_follow_up' if r.follow_up else 'flag_follow_up') ) }}"
                      method="post">
                      <input type="hidden" name="timestamp" value="{{ r.timestamp }}">
                      <button class="dropdown-item py-2">
                        <i class="fas fa-flag me-2 text-warning"></i> {{ 'Unflag' if r.follow_up else 'Flag' }}
                      </button>
                    </form>
                  </li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li>
                    <form action="{{ url_for('delete_record') }}" method="post"
                      onsubmit="return confirm('Delete this record?');">
                      <input type="hidden" name="timestamp" value="{{ r.timestamp }}">
                      <button class="dropdown-item py-2 text-danger"><i class="fas fa-trash me-2"></i> Delete</button>
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          <!-- Inline Reply Section -->
          <tr class="bg-light bg-opacity-25 border-bottom">
            <td colspan="9" class="ps-4 py-3">
              <div class="d-flex flex-column gap-2 ms-5">
                {% if r.doctor_replies_list %}
                <div class="small text-muted mb-2 ps-3 border-start border-primary border-3">
                  <strong>Recent Replies:</strong>
                  {% for m in r.doctor_replies_list[-2:] %}
                  <div class="d-flex align-items-center gap-2 mt-1">
                    <span class="badge bg-white border text-secondary fw-normal">{{ m.time }}</span>
                    <span>{{ m.message }}</span>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
                <form class="d-flex gap-2" action="{{ url_for('doctor_reply') }}" method="post">
                  <input type="hidden" name="timestamp" value="{{ r.timestamp }}">
                  <input class="form-control form-control-sm border-0 bg-white shadow-sm" type="text" name="message"
                    placeholder="Type a reply to {{ r.username }}..." required style="border-radius: 20px;">
                  <button class="btn btn-primary btn-sm px-4 shadow-sm" style="border-radius: 20px;"><i
                      class="fas fa-paper-plane"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="text-center py-5 fade-in-up">
  <div class="icon-box mx-auto mb-3" style="font-size: 3rem; width: 100px; height: 100px;">
    <i class="fas fa-folder-open"></i>
  </div>
  <h3 class="text-muted">No pending records</h3>
  <p class="text-muted mb-0">Great job! You're all caught up.</p>
</div>
{% endif %}
{% endblock %}