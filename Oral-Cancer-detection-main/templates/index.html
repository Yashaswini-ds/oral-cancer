{% extends "base.html" %}
{% block title %}Start Screening{% endblock %}
{% block content %}
<div class="card shadow-sm fade-in-up">
  <div class="card-body p-4">
    <h2 class="mb-4 fw-bold" style="color: var(--primary-color);">Screening Form</h2>
    <form action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" class="row g-3"
      id="screeningForm">

      <!-- Image Upload Section -->
      <div class="col-12">
        <h5 class="mb-3 text-primary"><i class="fas fa-camera me-2"></i>Upload Oral Scans</h5>
        <div class="alert alert-info small"><i class="fas fa-info-circle me-1"></i> Please upload 3 images for accurate
          AI averaging. You can also use the camera.</div>

        <div class="row g-3">
          <!-- Image 1 -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Scan 1 (Front View)</label>
            <input class="form-control mb-2" type="file" name="image1" accept="image/*" id="file1">
            <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="openCamera(1)"><i
                class="fas fa-video me-1"></i> Use Camera</button>
            <input type="hidden" name="camera_image1" id="camera_input_1">
            <img id="preview1" class="img-thumbnail mt-2 d-none" style="height: 150px; width: 100%; object-fit: cover;">
          </div>
          <!-- Image 2 -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Scan 2 (Left Side)</label>
            <input class="form-control mb-2" type="file" name="image2" accept="image/*" id="file2">
            <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="openCamera(2)"><i
                class="fas fa-video me-1"></i> Use Camera</button>
            <input type="hidden" name="camera_image2" id="camera_input_2">
            <img id="preview2" class="img-thumbnail mt-2 d-none" style="height: 150px; width: 100%; object-fit: cover;">
          </div>
          <!-- Image 3 -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Scan 3 (Right Side)</label>
            <input class="form-control mb-2" type="file" name="image3" accept="image/*" id="file3">
            <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="openCamera(3)"><i
                class="fas fa-video me-1"></i> Use Camera</button>
            <input type="hidden" name="camera_image3" id="camera_input_3">
            <img id="preview3" class="img-thumbnail mt-2 d-none" style="height: 150px; width: 100%; object-fit: cover;">
          </div>
        </div>
      </div>

      <!-- Camera Modal -->
      <div class="modal fade" id="cameraModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Take Photo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <video id="video" width="100%" height="auto" autoplay playsinline muted
                style="border-radius: 10px;"></video>
              <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn btn-primary rounded-pill px-4" onclick="capturePhoto()"><i
                  class="fas fa-camera me-2"></i>Capture</button>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Doctor Selection Section -->
      <div class="col-12 mb-4">
        <h5 class="mb-3 text-primary"><i class="fas fa-user-md me-2"></i>Select Consultant</h5>
        <div class="form-floating shadow-sm rounded-4">
          <select class="form-select border-0 bg-white" id="doctor_id" name="doctor_id" required>
            <option value="" selected disabled>Choose a specialist...</option>
            {% for doc in doctors %}
            <option value="{{ doc.id }}">Dr. {{ doc.username }} ({{ doc.specialization or "General" }})</option>
            {% endfor %}
          </select>
          <label for="doctor_id" class="text-muted">Consulting Doctor</label>
        </div>
        <div class="form-text ms-2"><i class="fas fa-info-circle me-1"></i> Your report will be sent securely to this
          doctor.</div>
      </div>

      <!-- Symptoms Section -->
      <h5 class="mb-3 text-primary"><i class="fas fa-notes-medical me-2"></i>Clinical Symptoms</h5>

      <div class="col-md-6">
        <label class="form-label">Pain Level</label>
        <select class="form-select" name="pain_level" required>
          <option value="" selected disabled>Choose...</option>
          <option>None</option>
          <option>Mild</option>
          <option>Moderate</option>
          <option>High</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Bleeding</label>
        <select class="form-select" name="bleeding" required>
          <option value="" selected disabled>Choose...</option>
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Swelling</label>
        <select class="form-select" name="swelling" required>
          <option value="" selected disabled>Choose...</option>
          <option>None</option>
          <option>Mild</option>
          <option>Moderate</option>
          <option>Severe</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Duration</label>
        <input class="form-control" type="text" name="duration" placeholder="e.g., 2 weeks">
      </div>
      <div class="col-md-8">
        <label class="form-label">Past Medical/Dental History</label>
        <input class="form-control" type="text" name="history" placeholder="e.g., family history of oral cancer">
      </div>

      <div class="col-12">
        <label class="form-label fw-bold">Habits</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="habitTobacco" name="habits" value="Tobacco"
            onchange="toggleYears('habitTobacco', 'tobaccoYearsDiv')">
          <label class="form-check-label" for="habitTobacco">Tobacco</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="habitAlcohol" name="habits" value="Alcohol"
            onchange="toggleYears('habitAlcohol', 'alcoholYearsDiv')">
          <label class="form-check-label" for="habitAlcohol">Alcohol</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="habitSmoking" name="habits" value="Smoking"
            onchange="toggleYears('habitSmoking', 'smokingYearsDiv')">
          <label class="form-check-label" for="habitSmoking">Smoking</label>
        </div>
      </div>

      <div class="col-md-4" id="tobaccoYearsDiv" style="display: none;">
        <label class="form-label">Tobacco Years</label>
        <input class="form-control" type="number" name="tobacco_years" min="0" step="1">
      </div>
      <div class="col-md-4" id="alcoholYearsDiv" style="display: none;">
        <label class="form-label">Alcohol Years</label>
        <input class="form-control" type="number" name="alcohol_years" min="0" step="1">
      </div>
      <div class="col-md-4" id="smokingYearsDiv" style="display: none;">
        <label class="form-label">Smoking Years</label>
        <input class="form-control" type="number" name="smoking_years" min="0" step="1">
      </div>

      <div class="col-md-6">
        <label class="form-label">3 Finger Trismus Test</label>
        <select class="form-select" name="trismus_test">
          <option value="" selected>Not answered</option>
          <option>Pass</option>
          <option>Fail</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Pain Opening Mouth</label>
        <select class="form-select" name="mouth_pain">
          <option value="" selected>Not answered</option>
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Extra Details</label>
        <textarea class="form-control" name="extra_details" rows="3"></textarea>
      </div>

      <div class="col-12">
        <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm pulse-effect" type="submit">Run AI
          Prediction</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentCameraTarget = 0;
  let videoStream = null;

  function toggleYears(checkboxId, divId) {
    const checkbox = document.getElementById(checkboxId);
    const div = document.getElementById(divId);
    if (checkbox.checked) {
      div.style.display = 'block';
      div.classList.add('fade-in-up');
    } else {
      div.style.display = 'none';
      div.querySelector('input').value = ''; // clear value
    }
  }

  function openCamera(targetIndex) {
    currentCameraTarget = targetIndex;
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();

    // Ensure video element exists and reset
    const video = document.getElementById('video');
    video.srcObject = null;

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // First try environment camera, if that fails (or not available), try any video source
      const startCamera = (constraints) => {
        navigator.mediaDevices.getUserMedia(constraints)
          .then(stream => {
            videoStream = stream;
            video.srcObject = stream;
            video.play();
          })
          .catch(err => {
            console.error("Camera Error with constraints:", constraints, err);
            if (constraints.video.facingMode) {
              // Retry without facingMode constraint
              console.log("Retrying without facingMode constraint...");
              startCamera({ video: true });
            } else {
              alert("Unable to access camera. Please ensure you have granted camera permissions and are using HTTPS or localhost.");
            }
          });
      };

      startCamera({ video: { facingMode: "environment" } });

    } else {
      alert("Camera API not supported in this browser.");
    }

    // Stop stream on modal close
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    });
  }

  function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    if (!video.srcObject) {
      alert("Camera not active!");
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // 0.8 quality to reduce size


    // Set hidden input
    document.getElementById(`camera_input_${currentCameraTarget}`).value = dataUrl;

    // Show preview
    const preview = document.getElementById(`preview${currentCameraTarget}`);
    preview.src = dataUrl;
    preview.classList.remove('d-none');

    // Clear file input if any
    document.getElementById(`file${currentCameraTarget}`).value = '';

    // Close modal
    const modalEl = document.getElementById('cameraModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  }
</script>
{% endblock %}