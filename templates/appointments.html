{% extends "base.html" %}
{% block title %}Appointments{% endblock %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<style>
    body {
        background-color: var(--bg-main);
        font-family: 'Inter', sans-serif;
    }

    .fc-event {
        cursor: pointer;
        border-radius: 6px;
        padding: 2px 5px;
        font-weight: 600;
        border: none !important;
    }

    #calendar {
        background: var(--surface);
        padding: 2.5rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--border-color);
    }

    .fc-toolbar-title {
        font-size: 1.75rem !important;
        font-weight: 800;
        color: var(--text-main);
        letter-spacing: -0.5px;
    }

    .fc-button-primary {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        border-radius: 50px !important;
        padding: 0.5rem 1.25rem !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        font-size: 0.75rem !important;
        letter-spacing: 0.5px !important;
        transition: var(--transition) !important;
    }

    .fc-button-primary:hover {
        background-color: var(--primary-hover) !important;
        border-color: var(--primary-hover) !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }

    .fc-button-active {
        background-color: var(--text-main) !important;
        border-color: var(--text-main) !important;
    }
</style>

<div class="container py-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark mb-0"><i class="fas fa-calendar-alt me-2 text-primary"></i>My Schedule</h2>
            <p class="text-secondary">Manage your appointments and consultations.</p>
        </div>
        <div class="col-md-4 text-md-end">
            {% if current_user.role == 'patient' %}
            <button class="btn btn-primary rounded-pill px-4 py-2 shadow-sm" data-bs-toggle="modal"
                data-bs-target="#bookingModal">
                <i class="fas fa-plus me-2"></i>Book Appointment
            </button>
            {% endif %}
        </div>
    </div>

    <div id='calendar'></div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Book an Appointment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('book_appointment') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Doctor</label>
                        <select class="form-select" name="doctor_id" required>
                            <!-- Doctors will be populated via backend or static for now if passed -->
                            <!-- We need to pass doctors to this template or use a fetch. 
                                  For now, let's assume valid doctor IDs are known or fetch them.
                                  Actually, better to pass 'doctors' list from route. -->
                            {% if doctors %}
                            {% for doc in doctors %}
                            <option value="{{ doc.id }}">Dr. {{ doc.username }} ({{ doc.specialization }})</option>
                            {% endfor %}
                            {% else %}
                            <option disabled>No doctors available</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Date</label>
                        <input type="date" class="form-control" name="date" required min="{{ get_today_date }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Time</label>
                        <input type="time" class="form-control" name="time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reason for Visit</label>
                        <textarea class="form-control" name="reason" rows="3"
                            placeholder="Briefly describe your symptoms..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Booking</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="eventTitle">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p><strong>Status:</strong> <span id="eventStatus" class="badge bg-secondary"></span></p>
                <p><strong>With:</strong> <span id="eventWith"></span></p>
                <p><strong>Time:</strong> <span id="eventTime"></span></p>
                <p><strong>Reason:</strong>
                <div class="p-3 bg-light rounded" id="eventReason"></div>
                </p>
            </div>
            <div class="modal-footer">
                <form id="cancelForm" method="POST" action="">
                    <button type="submit" class="btn btn-danger text-white">Cancel Appointment</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/api/appointments',
            eventClick: function (info) {
                // Populate and show modal
                document.getElementById('eventTitle').innerText = info.event.title;
                document.getElementById('eventStatus').innerText = info.event.extendedProps.status;

                let withName = info.event.extendedProps.doctorName;
                if ("{{ current_user.role }}" === "doctor") {
                    withName = info.event.extendedProps.patientName;
                }
                document.getElementById('eventWith').innerText = withName;

                document.getElementById('eventTime').innerText = info.event.start.toLocaleString();
                document.getElementById('eventReason').innerText = info.event.extendedProps.reason || "No reason provided.";

                // Update cancel action
                const cancelForm = document.getElementById('cancelForm');
                cancelForm.action = "/cancel_appointment/" + info.event.id;

                const status = info.event.extendedProps.status;
                if (status === 'Cancelled' || status === 'Completed') {
                    cancelForm.style.display = 'none';
                } else {
                    cancelForm.style.display = 'block';
                }

                var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                modal.show();
            }
        });
        calendar.render();
    });
</script>
{% endblock %}