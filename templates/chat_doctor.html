{% extends "base.html" %}
{% block title %}Chat (Doctor){% endblock %}
{% block content %}
<div class="container py-5 fade-in-up">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-navy text-white p-4">
          <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-20 p-2 rounded-3 me-3 text-primary">
              <i class="fas fa-user-md fs-4"></i>
            </div>
            <div>
              <h5 class="mb-0 fw-black">Physician-Patient Bridge</h5>
              <p class="mb-0 small opacity-75 text-primary">Active Record: {{ record.timestamp }}</p>
            </div>
          </div>
        </div>

        <div class="card-body p-4 bg-light bg-opacity-50" style="height: 450px; overflow-y: auto;">
          <div class="d-flex flex-column gap-3">
            {% set all_messages = [] %}
            {% if record.doctor_replies_list %}
            {% for m in record.doctor_replies_list %}
            {% set _ = all_messages.append({'from': 'doctor', 'message': m.message, 'time': m.time}) %}
            {% endfor %}
            {% endif %}
            {% if record.patient_replies_list %}
            {% for m in record.patient_replies_list %}
            {% set _ = all_messages.append({'from': 'patient', 'message': m.message, 'time': m.time}) %}
            {% endfor %}
            {% endif %}

            {% for m in all_messages | sort(attribute='time') %}
            <div class="d-flex mt-2 {% if m.from == 'doctor' %}justify-content-end{% endif %}">
              <div class="max-width-80">
                <div
                  class="px-3 py-2 rounded-4 shadow-sm {% if m.from == 'doctor' %}bg-navy text-white rounded-bottom-end-0{% else %}bg-white text-navy border rounded-bottom-start-0{% endif %}">
                  <div class="small fw-black mb-1 opacity-75">{% if m.from == 'doctor' %}You (Doctor){% else
                    %}Patient{% endif %}</div>
                  <div>
                    {% if m.type == 'image' %}
                    <img src="{{ url_for('static', filename=m.file_path.split('static/')[1]) }}"
                      class="img-fluid rounded mb-2" style="max-height: 200px;" alt="Image">
                    {% if m.message %}<div class="small">{{ m.message }}</div>{% endif %}
                    {% elif m.type == 'video' %}
                    <video controls class="img-fluid rounded mb-2" style="max-height: 200px;">
                      <source src="{{ url_for('static', filename=m.file_path.split('static/')[1]) }}"
                        type="video/{{ m.file_path.split('.')[-1] }}">
                      Your browser does not support the video tag.
                    </video>
                    {% if m.message %}<div class="small">{{ m.message }}</div>{% endif %}
                    {% elif m.type == 'audio' %}
                    <audio controls class="w-100 mb-1">
                      <source src="{{ url_for('static', filename=m.file_path.split('static/')[1]) }}" type="audio/wav">
                      Your browser does not support the audio element.
                    </audio>
                    {% if m.message != "Voice Message" %}<div class="small">{{ m.message }}</div>{% endif %}
                    {% else %}
                    {{ m.message }}
                    {% endif %}
                  </div>
                </div>
                <div class="{% if m.from == 'doctor' %}text-end{% endif %} mt-1">
                  <small class="text-muted" style="font-size: 0.65rem;">{{ m.time }}</small>
                </div>
              </div>
            </div>
            {% else %}
            <div class="text-center py-5 opacity-50">
              <i class="fas fa-comment-medical fs-1 mb-3"></i>
              <p>Initiate conversation with patient.</p>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="card-footer bg-white p-3 border-top">
          <form class="d-flex gap-2 align-items-center" method="post" action="{{ url_for('chat_reply_doctor') }}"
            enctype="multipart/form-data">
            <input type="hidden" name="timestamp" value="{{ record.timestamp }}">

            <!-- File Attachment -->
            <label class="btn btn-navy rounded-circle shadow-sm d-flex align-items-center justify-content-center"
              style="width: 45px; height: 45px; cursor: pointer;">
              <i class="fas fa-paperclip text-white"></i>
              <input type="file" name="file" class="d-none" accept="image/*,video/*">
            </label>

            <!-- Voice Recorder -->
            <button type="button" id="recordBtnDoc"
              class="btn btn-navy rounded-circle shadow-sm d-flex align-items-center justify-content-center"
              style="width: 45px; height: 45px;">
              <i class="fas fa-microphone text-white"></i>
            </button>
            <input type="file" name="audio" id="audioInputDoc" class="d-none" accept="audio/*">

            <input class="form-control rounded-pill border-0 bg-light px-4" type="text" name="message"
              id="messageInputDoc" placeholder="Type instructions or queries...">

            <button type="submit"
              class="btn btn-navy rounded-circle shadow-sm d-flex align-items-center justify-content-center"
              style="width: 45px; height: 45px;">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>

          <!-- Recording Indicator -->
          <div id="recordingStatusDoc"
            class="d-none align-items-center justify-content-center mt-2 text-danger animate-pulse">
            <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> Recording... <span id="recordTimerDoc"
              class="ms-2 font-monospace">00:00</span>
            <button type="button" id="stopBtnDoc" class="btn btn-sm btn-danger ms-3 rounded-pill px-3">Stop &
              Attach</button>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="{{ url_for('doctor_dashboard') }}" class="text-muted text-decoration-none small fw-bold">
          <i class="fas fa-arrow-left me-1"></i> Back to Clinical Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .max-width-80 {
    max-width: 85%;
  }

  .rounded-bottom-end-0 {
    border-bottom-right-radius: 0 !important;
  }

  .rounded-bottom-start-0 {
    border-bottom-left-radius: 0 !important;
  }

  .animate-pulse {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }

    50% {
      opacity: 0.5;
    }

    100% {
      opacity: 1;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const recordBtn = document.getElementById('recordBtnDoc');
    const stopBtn = document.getElementById('stopBtnDoc');
    const recordingStatus = document.getElementById('recordingStatusDoc');
    const audioInput = document.getElementById('audioInputDoc');
    const messageInput = document.getElementById('messageInputDoc');
    const recordTimer = document.getElementById('recordTimerDoc');

    let mediaRecorder;
    let audioChunks = [];
    let startTime;
    let timerInterval;

    recordBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Audio recording is not supported in this browser.');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // or webm
          const audioFile = new File([audioBlob], "doctor_voice_message.wav", { type: 'audio/wav' });

          // Create a DataTransfer to set the file input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(audioFile);
          audioInput.files = dataTransfer.files;

          messageInput.placeholder = "Voice message attached ready to send.";
          messageInput.required = false;

          audioChunks = [];
        };

        mediaRecorder.start();
        startTime = Date.now();
        recordingStatus.classList.remove('d-none');
        recordingStatus.classList.add('d-flex');

        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
          const secs = (elapsed % 60).toString().padStart(2, '0');
          recordTimer.textContent = `${mins}:${secs}`;
        }, 1000);

      } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Could not access microphone.');
      }
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());

        recordingStatus.classList.add('d-none');
        recordingStatus.classList.remove('d-flex');
        clearInterval(timerInterval);
      }
    });
  });
</script>
{% endblock %}